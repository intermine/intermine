<project name="flymine-www" default="transform-site" basedir=".">

  <property name="build.properties.local.base" 
            value="${user.home}/build.properties.flymine-webapp"/>
  <condition property="build.properties.local" value="${build.properties.local.base}.${release}"
             else="${build.properties.local.base}">
    <available file="${build.properties.local.base}.${release}"/>
  </condition>
  <available file="${build.properties.local}" property="build.properties.local.present"/>
  <fail message="${build.properties.local} not found" unless="build.properties.local.present"/>
  
  <property name="runtime.properties.local.base" value="${user.home}/flymine-webapp.properties" />
  <condition property="runtime.properties.local" value="${runtime.properties.local.base}.${release}"
             else="${runtime.properties.local.base}">
    <available file="${runtime.properties.local.base}.${release}"/>
  </condition>
  <available file="${runtime.properties.local}" property="runtime.properties.local.present"/>
  <fail message="${runtime.properties.local} not found" unless="runtime.properties.local.present"/>
  
  <property name="common" location="../common"/>
  <property name="common.lib" location="${common}/lib"/>
  <property name="common.scripts" location="${common}/scripts"/>
  <property name="src.www" location="site"/>
  <property name="common.src.www" location="${common}/site"/>
  <property name="src.doc" location="../../flymine/doc"/>
  <property name="library.xml.basedir" location="../../imbuild"/>
  <property name="build.www" location="build"/>
  <property name="build.webapp.manual.html" location="dist/doc/manual"/>
  <property name="dist.www" location="dist"/>
  <property name="xslt" location="xslt"/>
  <property name="common.xslt" location="${common}/xslt"/>
  <property name="cache.dtd" location="${common}/dtd"/>
  <property name="output.extension" value="shtml"/>
  <property name="branding" value="flymine"/>

  <path id="xslt.class.path">
    <fileset dir="${library.xml.basedir}/im-ant-tasks/lib" includes="*.jar"/>
  </path>

  <target name="prepare">
    <property name="build.properties.local" value="${user.home}/build.properties.flymine" />
    <property file="${build.properties.local}"/>

   <copy todir="${build.www}">
      <fileset dir="${src.www}">
        <include name="**/*"/>
      </fileset>
      <fileset dir="${common.src.www}">
        <include name="**/*"/>
      </fileset>
    </copy>

    <copy file="rss.xml" todir="${dist.www}"/>
    <copy file="${src.www}/robots.txt" todir="${dist.www}"/>

    <copy todir="${dist.www}">
      <fileset dir="${src.www}">
        <include name="images/*"/>
      </fileset>
    </copy>

    <copy todir="${dist.www}">
      <fileset dir="${src.www}">
        <include name="style/*"/>
      </fileset>
    </copy>

    <copy todir="${dist.www}">
      <fileset dir="${src.www}">
        <include name="js/*"/>
      </fileset>
    </copy>
  </target>

  <target name="style-site" depends="prepare">
    <xslt basedir="${src.www}/" destdir="${dist.www}" extension=".${output.extension}"
           style="${common.xslt}/new.xsl" 
           force="false">
      <classpath refid="xslt.class.path"/>
      <include name="**/*.html"/>
      <exclude name="help/tour/*"/>
      <exclude name="help/tutorials/*"/>
      <exclude name="help/whatcanidoonthispage/*"/>
      <param name="branding" expression="${branding}" />
      <param name="basedir" expression="${project.sitePrefix}" />
      <param name="webappprefix" expression="${webapp.baseurl}/${webapp.path}"/>
      <param name="projectcontact" expression="${project.contact}"/>
      <param name="releaseversion" expression="${project.releaseVersion}"/>
      <param name="webapppath" expression="${webapp.path}"/>
      <param name="outputext" expression="${output.extension}" />
    </xslt>
  </target>
  
  <target name="generate-help" depends="prepare" 
          description="Generate html for tour and copy images to build directory">
 
 		<mkdir dir="${dist.www}/help"/>
 
     <exec executable="${common.scripts}/process_help.pl">
       <arg value="${src.www}/help/whatcanidoonthispage/whatcanido.html"/>
       <arg value="FlyMine Help"/>
       <arg value="${dist.www}/help"/>
     </exec>
  </target>
  
  <target name="generate-tour" depends="prepare" 
          description="Generate html for tour and copy images to build directory">
     <mkdir dir="${dist.www}/help/tour"/>

     <exec executable="${common.scripts}/process_help.pl">
       <arg value="${src.www}/help/tour/tour.txt"/>
       <arg value="FlyMine Tour"/>
       <arg value="${dist.www}/help/tour"/>
     </exec>
  </target>


  <target name="generate-sitemap" depends="prepare" 
          description="Generate sitemap for website">

     <exec executable="${common.scripts}/sitemap_gen.pl">  
          <arg value="${dist.www}"/>
     </exec>
  </target>

  <!-- site isn't currently validated - the webapp header includes the <head> element
       and this is read by SSI, so files in dist don't validate. -->
  <target name="validate-site-xhtml"
          depends="style-site">
    <xmlvalidate warn="yes">
      <fileset dir="${dist.www}" includes="**/*.shtml">
        <exclude name="images/index.html"/>
        <exclude name="stats.html"/>
        <exclude name="what.shtml"/>
        <exclude name="**/tour*.html"/>
        <exclude name="graphics/index.html"/>
        <exclude name="sources-table.html"/>
        <exclude name="html/**/*"/>
      </fileset>
      <xmlcatalog>
        <dtd 
          publicId="-//W3C//DTD XHTML 1.0 Transitional//EN"
          location="${cache.dtd}/xhtml1-transitional.dtd"/>
        </xmlcatalog>
   </xmlvalidate>
  </target>

  <target name="transform-site"
          depends="style-site, validate-site-xhtml"
          description="Transform the website contents from XML to HTML"/>




  <target name="release-www" depends="style-site, generate-tour, generate-help, generate-sitemap"
          description="releases the static website to the webserver">
    <fixcrlf srcdir="${dist.www}"
       eol="crlf"
       includes="**/*.css"/>
    <chmod perm="a+r" type="file">
      <fileset dir="${dist.www}">
        <include name="**/**" />
      </fileset>
    </chmod>
    <chmod perm="a+rx" type="dir">
      <fileset dir="${dist.www}">
        <include name="**/**" />
      </fileset>
    </chmod>
    <exec executable="rsync">
      <arg line="-e ssh -Cavz --exclude api --exclude tmp --exclude gbrowse --delete ${dist.www}/ ${www.serverlocation}/" />
    </exec>
  </target>

  <target name="clean">
    <delete dir="${build.www}"/>
    <delete dir="${dist.www}"/>
  </target>
</project>
