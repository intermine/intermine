
<project name="flymine-webapp" default="default" basedir=".">


  <description>build, test, package flymine-webapp</description>
  <import file="../../imbuild/application.xml"/>

  <target name="-pre-jar"
          depends="application.-pre-jar, -add-struts-config"/>
 
  <!-- it's hacky to override do-generate, but it gets run at the right time -->
  <target name="do-generate">
    <ant antfile="build.xml" dir="../dbmodel" target="summarise-objectstore" inheritAll="false"/>
    <mkdir dir="${build.dir}/webapp"/>
    <ant antfile="build.xml" dir="../sitemap" target="generate-sitemap" inheritAll="false">
      <property name="sitemap.output" value="${build.dir}/webapp"/>
    </ant>
  </target>

  <target name="-add-struts-config"
          description="Append the struts config modifications to the webapp"
  	  depends="-pre-init">
    <unwar src="${dist.war}" dest="${build.dir}/webapp/">
      <patternset>
  	<include name="WEB-INF/struts-config.xml"/>
        <include name="WEB-INF/tiles-defs.xml"/>
      </patternset>
    </unwar>

    <loadfile property="model.struts.config" srcFile="./resources/struts-config-model.xml"/>

    <replace file="${build.dir}/webapp/WEB-INF/struts-config.xml" value="${model.struts.config}">
      <!-- can't use normal token as xml must be parseable before this replacement -->
      <replacetoken><![CDATA[<!--@MODEL_INCLUDE@-->]]></replacetoken>
    </replace>

    <loadfile property="model.tiles.defs" srcFile="./resources/tiles-defs-model.xml"/>

    <replace file="${build.dir}/webapp/WEB-INF/tiles-defs.xml" value="${model.tiles.defs}">
      <!-- can't use normal token as xml must be parseable before this replacement -->
      <replacetoken><![CDATA[<!--@MODEL_INCLUDE@-->]]></replacetoken>
    </replace>

    <war destfile="${dist.war}" update="true" >
      <webinf dir="${build.dir}/webapp/WEB-INF/">
  	<filename name="struts-config.xml" />
        <filename name="tiles-defs.xml" />
      </webinf>
    </war>

   </target>

</project>
